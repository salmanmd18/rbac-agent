# FinSolve RBAC Chatbot

Role-aware Retrieval Augmented Generation (RAG) chatbot. The solution enables FinSolve teams to query internal data with fine-grained role based access control (RBAC) across both unstructured documents and structured CSV datasets.


## Features
- FastAPI backend with HTTP Basic authentication, centralized role mapping, and RBAC enforcement at retrieval time.
- Chroma vector store with `all-MiniLM-L6-v2` embeddings for scoped RAG responses.
- Groq LLM integration (`llama-3.1-8b-instant`) with a deterministic summary fallback when no API key is available.
- DuckDB-backed SQL path for department CSV files with strict table filtering and automatic fallback to RAG on policy or execution failures.
- Optional cross-encoder reranker (toggle with `ENABLE_RERANKER=true`) to reprioritise retrieved chunks, plus an in-memory LRU cache that avoids redundant lookups per role/message.
- Streamlit chat UI featuring login, chat history, configurable retrieval depth, surfaced SQL table list, and source citations.
- Built-in analytics endpoint (C-level only) reporting per-role usage, cache size, and reranker status—surface insights directly in the Streamlit sidebar.

## Quick Start
1. **Clone the repository**
   ```bash
   git clone https://github.com/<your-username>/rbac-agent.git
   cd rbac-agent
   ```
2. **Create a uv-managed virtual environment**
   ```bash
   uv venv .venv
   .venv\Scripts\activate          # Windows
   # source .venv/bin/activate     # macOS/Linux
   ```
3. **Install dependencies**
   ```bash
   uv pip sync requirements.lock
   # Regenerate the lock if you modify pyproject.toml:
   # uv pip compile pyproject.toml --output-file requirements.lock
   ```
4. **Configure environment variables**
   ```bash
   copy .env.example .env           # Windows
   # cp .env.example .env           # macOS/Linux
   ```
   Populate values such as:
   - `GROQ_API_KEY`: optional, enables Groq-hosted LLM responses.
   - `FINCHAT_BACKEND_URL`: backend URL used by the Streamlit app (defaults to `http://localhost:8000`).
   - `ENABLE_RERANKER`: set to `true` to load the optional cross-encoder reranker (defaults to `false`).

## Running the Backend
```bash
uvicorn app.main:app --reload
```
The API exposes:
- `GET /login`: validates credentials and returns the authenticated role.
- `POST /chat`: routes through SQL or RAG depending on the classifier while enforcing role permissions.
- `GET /roles`: lists roles with their accessible departments.
- `GET /health`: readiness probe.

For structured access, CSV files placed under `resources/data/<department>/` are exposed automatically. Table names follow the pattern `<department>_<filename>` (lowercase). The SQL service only accepts single `SELECT` statements and limits results to 50 rows; failures trigger a role-scoped RAG fallback with an explanatory note.

## Streamlit Chat UI
Run the web UI in a separate terminal:
```bash
streamlit run streamlit_app.py
```
- Enter your username/password to authenticate against the FastAPI backend.
- Ask natural language questions; unstructured queries use the RAG path, while SQL-style queries (e.g., `SELECT * FROM hr_hr_data WHERE performance_rating >= 4`) run against the allowed CSV tables.
- Adjust the `Top K` slider to control the number of RAG context chunks retrieved per request.

### Sample Credentials
| Username | Password     | Role        |
|----------|--------------|-------------|
| Tony     | password123  | engineering |
| Bruce    | securepass   | marketing   |
| Sam      | financepass  | finance     |
| Natasha  | hrpass123    | hr          |
| Priya    | cboard123    | c_level     |
| Anita    | employee123  | employee    |

## Project Structure
```
app/
├── main.py               # FastAPI entrypoint
├── schemas/              # Pydantic request/response models
└── services/             # RBAC, RAG, SQL, and LLM service implementations
resources/
└── data/                 # Department-specific knowledge base (markdown + CSV)
streamlit_app.py          # Streamlit front-end
pyproject.toml            # Dependency management
requirements.lock         # Resolved dependency lock (generated by uv)
.env.example              # Sample environment configuration
```

## Testing
```bash
uv run pytest
```
The suite covers the classifier heuristics, cache behaviour, analytics/authorization rules, SQL policy enforcement, and the `/chat` endpoint SQL happy path for the HR role.

## Offline Evaluation
Generate quick metrics using the built-in evaluator:
```bash
uv run python tools/offline_eval.py --dataset eval_samples.json --output results/eval.csv
```
Seed `eval_samples.json` with role-specific prompts and expected keywords to track groundedness/keyword precision. The evaluator runs entirely offline using FastAPI’s TestClient.

## Extending the Solution
- Update role mappings in `app/services/role_manager.py` to add departments or tailor permissions.
- Add markdown documents to `resources/data/<department>` to expand the RAG knowledge base.
- Place CSV assets under the same department directory to expose them automatically through DuckDB.
- Swap the embedding model or vector store settings in `app/services/rag_service.py` if needed.
- Extend `app/services/reranker.py` to plug in production-grade rerankers (e.g., Cohere) once API keys are available.
- Expand `app/services/metrics.py` or the `/analytics` endpoint to persist metrics externally or drive richer dashboards.

> **Note:** Without a `GROQ_API_KEY`, the chatbot falls back to a deterministic summary composed from retrieved chunks, ensuring the app remains functional for local testing.
